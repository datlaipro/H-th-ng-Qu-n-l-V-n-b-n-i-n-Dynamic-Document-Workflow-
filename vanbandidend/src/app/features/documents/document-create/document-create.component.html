<div class="shell">
  <div class="card">
    <div class="card-head">
      <h2>Tạo mới văn bản</h2>
      <div class="hint">Đi = OUTBOUND • Đến = INBOUND</div>
    </div>

    <form [formGroup]="form" (ngSubmit)="submit()" class="form-grid">

      <!-- Loại văn bản -->
      <mat-form-field appearance="outline">
        <mat-label>Loại văn bản</mat-label>
        <mat-select formControlName="doc_type">
          <mat-option value="OUTBOUND">Văn bản Đi</mat-option>
          <mat-option value="INBOUND">Văn bản Đến</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Số hiệu -->
      <mat-form-field appearance="outline">
        <mat-label>Số hiệu văn bản</mat-label>
        <input matInput formControlName="doc_number" placeholder="VD: OB-2025-101 / IB-2025-001">
        <mat-error *ngIf="form.get('doc_number')?.hasError('required')">Bắt buộc</mat-error>
      </mat-form-field>

      <!-- Tiêu đề -->
      <mat-form-field appearance="outline" class="full">
        <mat-label>Tiêu đề</mat-label>
        <input matInput formControlName="title" placeholder="Nhập tiêu đề">
        <mat-error *ngIf="form.get('title')?.hasError('required')">Bắt buộc</mat-error>
      </mat-form-field>

      <!-- Nội dung -->
      <mat-form-field appearance="outline" class="full">
        <mat-label>Nội dung</mat-label>
        <textarea matInput rows="6" formControlName="content" placeholder="Tóm tắt nội dung..."></textarea>
        <mat-error *ngIf="form.get('content')?.hasError('required')">Bắt buộc</mat-error>
      </mat-form-field>

      <!-- Dynamic date: OUTBOUND -> issued_at / INBOUND -> received_at -->
      <mat-form-field appearance="outline">
        <mat-label *ngIf="docType() === 'OUTBOUND'">Ngày ban hành</mat-label>
        <mat-label *ngIf="docType() === 'INBOUND'">Ngày nhận</mat-label>
        <input matInput [matDatepicker]="picker" [formControlName]="docType() === 'OUTBOUND' ? 'issued_at' : 'received_at'">
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>

        <mat-error *ngIf="docType() === 'OUTBOUND' && form.get('issued_at')?.hasError('required')">
          Bắt buộc cho văn bản Đi
        </mat-error>
        <mat-error *ngIf="docType() === 'INBOUND' && form.get('received_at')?.hasError('required')">
          Bắt buộc cho văn bản Đến
        </mat-error>
      </mat-form-field>

      <!-- Dynamic unit: OUTBOUND -> recipient_unit / INBOUND -> sender_unit -->
      <mat-form-field appearance="outline">
        <mat-label *ngIf="docType() === 'OUTBOUND'">Nơi nhận</mat-label>
        <mat-label *ngIf="docType() === 'INBOUND'">Nơi gửi</mat-label>
        <input
          matInput
          [formControlName]="docType() === 'OUTBOUND' ? 'recipient_unit' : 'sender_unit'"
          [placeholder]="docType() === 'OUTBOUND' ? 'VD: Phòng Hành chính' : 'VD: Sở Y tế'">
        <mat-error *ngIf="docType() === 'OUTBOUND' && form.get('recipient_unit')?.hasError('required')">
          Bắt buộc cho văn bản Đi
        </mat-error>
        <mat-error *ngIf="docType() === 'INBOUND' && form.get('sender_unit')?.hasError('required')">
          Bắt buộc cho văn bản Đến
        </mat-error>
      </mat-form-field>

      <mat-divider class="full"></mat-divider>

      <!-- File attachments -->
      <div class="files full">
        <div class="files-head">
          <h3>File đính kèm</h3>
          <button type="button" mat-stroked-button (click)="filePicker.click()" matTooltip="Chọn nhiều file">
            <mat-icon>upload_file</mat-icon>&nbsp;Chọn file
          </button>
          <input #filePicker type="file" (change)="onPickFiles($event)" multiple hidden>
        </div>

        <div class="chips" *ngIf="files().length">
          <mat-chip-listbox>
            <mat-chip *ngFor="let f of files(); let i = index" [removable]="true" (removed)="removeFile(i)">
              <mat-icon matChipAvatar>attach_file</mat-icon>
              {{ f.name }} ({{ f.size | number }} bytes)
              <button matChipRemove mat-icon-button aria-label="Xoá file">
                <mat-icon>close</mat-icon>
              </button>
            </mat-chip>
          </mat-chip-listbox>
        </div>

        <mat-progress-bar *ngIf="uploading()" mode="determinate" [value]="uploadProgress() ?? 0"></mat-progress-bar>
      </div>

      <div class="actions full">
        <button mat-stroked-button type="reset">Làm lại</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="uploading()">Tạo văn bản</button>
      </div>
    </form>
  </div>
</div>
